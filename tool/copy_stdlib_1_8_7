#!/usr/bin/env jruby

# This script is for use with JRuby, to copy the (patched) stdlib files from
# various locations in MRI's layout to JRuby's layout. It should be used
# against the jruby-specific fork of MRI's repository at
# github.com/jruby/ruby. This version is for the 1.8.7 stdlib, and should
# be used against the jruby-ruby_1_8_7 branch.
#
# usage: copy_stdlib <fork clone on jruby-ruby_1_8_7> <jruby dir>

require 'fileutils'

# stdlib notes:
# Win32API is a native ext in MRI but a .rb for us
# dl.rb is generated in MRI(???), static for us
# generator.rb is generator_internal.rb in builtin for us and mostly different from MRI
# rdoc/ri contains functionality for java classes and requires jar-file+cache support in jruby's site_lib
# tempfile is native on JRuby so there's no tempfile.rb
# timeout is native on JRuby so there's no timeout.rb
# weakref is native on JRuby so there's no weakref.rb
STDLIB_FILES = %w[
  English.rb
  Env.rb
  README
  Win32API.rb
  abbrev.rb
  base64.rb
  benchmark.rb
  cgi
  cgi-lib.rb
  cgi.rb
  complex.rb
  csv.rb
  date
  date.rb
  date2.rb
  debug.rb
  delegate.rb
  dl.rb
  drb
  drb.rb
  e2mmap.rb
  erb.rb
  eregex.rb
  fileutils.rb
  finalize.rb
  find.rb
  forwardable.rb
  ftools.rb
  generator.rb
  getoptlong.rb
  getopts.rb
  gserver.rb
  importenv.rb
  ipaddr.rb
  irb
  irb.rb
  jcode.rb
  logger.rb
  mailread.rb
  mathn.rb
  matrix.rb
  mkmf.rb
  monitor.rb
  mutex_m.rb
  net
  observer.rb
  open-uri.rb
  open3.rb
  optparse
  optparse.rb
  ostruct.rb
  parsearg.rb
  parsedate.rb
  pathname.rb
  ping.rb
  pp.rb
  prettyprint.rb
  profile.rb
  profiler.rb
  pstore.rb
  racc
  rational.rb
  rdoc
  readbytes.rb
  resolv-replace.rb
  resolv.rb
  rexml
  rinda
  rss
  rss.rb
  rubyunit.rb
  runit
  scanf.rb
  securerandom.rb
  set.rb
  shell
  shell.rb
  shellwords.rb
  singleton.rb
  soap
  sync.rb
  test
  thread.rb
  thwait.rb
  time.rb
  tmpdir.rb
  tracer.rb
  tsort.rb
  un.rb
  uri
  uri.rb
  webrick
  webrick.rb
  wsdl
  xmlrpc
  xsd
]

EXT_FILES = {
  'ext/bigdecimal/lib/bigdecimal' => 'bigdecimal',
  'ext/dl/lib/dl' => 'dl',
  'ext/pty/lib/expect.rb' => 'expect.rb',
  'ext/io/wait/lib/nonblock.rb' => 'io/nonblock.rb',
  'ext/nkf/lib/kconv.rb' => 'kconv.rb',
  'ext/digest/lib/md5.rb' => 'md5.rb',
  'ext/digest/lib/sha1.rb' => 'sha1.rb',
  'ext/Win32API/lib/win32' => 'win32'
}

# yaml files go into src/builtin for jruby
YAML_FILES = %w[
  yaml.rb
  yaml
]

if ARGV.size < 2
  puts "usage: copy_stdlib <jruby ruby fork clone> <jruby dir>"
  exit 1
elsif !File.exist?(ARGV[0]) || !File.directory?(ARGV[0])
  puts "invalid source dir: #{ARGV[0]}"
  exit 1
elsif !File.exist?(ARGV[1]) || !File.directory?(ARGV[1])
  puts "invalid target dir: #{ARGV[1]}"
  exit 1
end

FORK_DIR = ARGV[0]
JRUBY_DIR = ARGV[1]

for file in STDLIB_FILES
  FileUtils.cp_r "#{FORK_DIR}/lib/#{file}", "#{JRUBY_DIR}/lib/ruby/1.8", :verbose => true
end

for file, target in EXT_FILES
  if File.directory? "#{FORK_DIR}/#{file}"
  	FileUtils.cp_r "#{FORK_DIR}/#{file}", "#{JRUBY_DIR}/lib/ruby/1.8/", :verbose => true
  else
  	FileUtils.cp_r "#{FORK_DIR}/#{file}", "#{JRUBY_DIR}/lib/ruby/1.8/#{target}", :verbose => true
  end
end

for file in YAML_FILES
  FileUtils.cp_r "#{FORK_DIR}/lib/#{file}", "#{JRUBY_DIR}/src/builtin", :verbose => true
end
